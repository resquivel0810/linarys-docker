version: '3.8'

services:
  db:
    container_name: db-nuevo
    image: mysql:5.7
    volumes:
      - ./database:/var/lib/mysql
      - ./mysqldumps/backup.sql:/docker-entrypoint-initdb.d/backup.sql  # Cambiado a .sql
      - ./init/restore.sh:/docker-entrypoint-initdb.d/restore.sh
    ports:
      - "3309:3306"
    environment:
      MYSQL_ROOT_PASSWORD: unamuysegura
      MYSQL_DATABASE: linarysdb
      MYSQL_USER: linarysdbuser
      MYSQL_PASSWORD: unamuysegura
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-punamuysegura"]
      interval: 10s
      retries: 20
    # Solo da permisos e inicia MySQL
    command: >
      bash -c "
      chmod +x /docker-entrypoint-initdb.d/*.sh 2>/dev/null || true;
      exec docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password
      "
    restart: always

  wordpress:
    container_name: wordpress-nuevo
    image: wordpress:latest
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./site/wp-content:/var/www/html/wp-content
      - ./init/fix-urls.sh:/fix-urls.sh
    ports:
      - "8888:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: linarysdbuser
      WORDPRESS_DB_PASSWORD: unamuysegura
      WORDPRESS_DB_NAME: linarysdb
      WORDPRESS_TABLE_PREFIX: dGY66rR_
    command: >
      bash -c "
      # Esperar a que la BD esté lista
      sleep 20
      
      # Si wp-config.php no existe, crearlo (evita instalación nueva)
      if [ ! -f /var/www/html/wp-config.php ]; then
        echo 'Creando wp-config.php desde variables de entorno...'
        cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php
        # Configurar BD
        sed -i \"s/database_name_here/linarysdb/\" /var/www/html/wp-config.php
        sed -i \"s/username_here/linarysdbuser/\" /var/www/html/wp-config.php
        sed -i \"s/password_here/unamuysegura/\" /var/www/html/wp-config.php
        sed -i \"s/localhost/db/\" /var/www/html/wp-config.php
        # Configurar prefijo
        sed -i \"s/\\\$table_prefix = 'wp_';/\\\$table_prefix = 'dGY66rR_';/\" /var/www/html/wp-config.php
      fi
      
      # Dar permisos y ejecutar fix-urls
      chmod +x /fix-urls.sh 2>/dev/null || true
      [ -x /fix-urls.sh ] && /fix-urls.sh &
      
      # Iniciar WordPress
      exec docker-entrypoint.sh apache2-foreground
      "
    restart: always

  adminer:
    container_name: adminer-nuevo
    image: adminer
    ports:
      - "8889:8080"
    restart: always