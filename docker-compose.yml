version: '3.8'

services:
  wordpress:
    container_name: wordpress-nuevo
    platform: linux/amd64
    depends_on:
      db:
        condition: service_healthy
    image: wordpress:latest
    volumes:
      - ./site/wp-content:/var/www/html/wp-content
      - ./init/prep.sh:/prep.sh
    ports:
      - "8888:80"
    restart: always
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: linarysdbuser
      WORDPRESS_DB_PASSWORD: unamuysegura
      WORDPRESS_DB_NAME: linarysdb
      WORDPRESS_TABLE_PREFIX: dGY66rR_
      WORDPRESS_DEBUG: "1"
      PRODUCTION_URL: "http://linarys.ch"
    # ✅ SOLUCIÓN: Entrypoint que SIEMPRE da permisos
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
      echo '=== Iniciando WordPress ==='
      echo 'Usuario: $(whoami)'
      echo 'Hora: $(date)'
      
      # 1. Dar permisos al script (no falla si no existe)
      if [ -f /prep.sh ]; then
        echo 'Dando permisos a /prep.sh...'
        chmod +x /prep.sh 2>/dev/null || true
        ls -la /prep.sh
      else
        echo 'Advertencia: /prep.sh no encontrado'
      fi
      
      # 2. Ejecutar script de preparación en segundo plano
      if [ -f /prep.sh ] && [ -x /prep.sh ]; then
        echo 'Ejecutando /prep.sh...'
        /prep.sh &
      fi
      
      # 3. Iniciar WordPress normalmente
      echo 'Iniciando Apache...'
      exec docker-entrypoint.sh apache2-foreground
      "

  db:
    container_name: db-nuevo
    image: mysql:5.7
    platform: linux/amd64
    volumes:
      - ./database:/var/lib/mysql
      - ./mysqldumps/backup.sql.gz:/docker-entrypoint-initdb.d/backup.sql.gz
      - ./init/migrate.sh:/docker-entrypoint-initdb.d/migrate.sh
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: unamuysegura
      MYSQL_DATABASE: linarysdb
      MYSQL_USER: linarysdbuser
      MYSQL_PASSWORD: unamuysegura
      WORDPRESS_TABLE_PREFIX: dGY66rR_
      PRODUCTION_URL: "http://linarys.ch"
    ports:
      - "3309:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-punamuysegura"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s
    # ✅ SOLUCIÓN: Entrypoint que SIEMPRE da permisos a migrate.sh
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
      echo '=== Iniciando MySQL ==='
      echo 'Usuario: $(whoami)'
      echo 'Hora: $(date)'
      
      # 1. Dar permisos a TODOS los scripts .sh en initdb.d
      echo 'Buscando scripts en /docker-entrypoint-initdb.d/...'
      ls -la /docker-entrypoint-initdb.d/ 2>/dev/null || echo 'Directorio no encontrado'
      
      if [ -d /docker-entrypoint-initdb.d/ ]; then
        echo 'Dando permisos a scripts .sh...'
        find /docker-entrypoint-initdb.d/ -name '*.sh' -type f -exec chmod +x {} \; 2>/dev/null || true
        echo 'Permisos actualizados:'
        find /docker-entrypoint-initdb.d/ -name '*.sh' -type f -exec ls -la {} \; 2>/dev/null || true
      fi
      
      # 2. Dar permisos específico a migrate.sh (por si acaso)
      if [ -f /docker-entrypoint-initdb.d/migrate.sh ]; then
        echo 'Dando permisos específicos a migrate.sh...'
        chmod +x /docker-entrypoint-initdb.d/migrate.sh
        echo 'Estado de migrate.sh:'
        ls -la /docker-entrypoint-initdb.d/migrate.sh
        echo 'Contenido de la primera línea (shebang):'
        head -1 /docker-entrypoint-initdb.d/migrate.sh || echo 'No se pudo leer'
      else
        echo 'Advertencia: migrate.sh no encontrado en /docker-entrypoint-initdb.d/'
      fi
      
      # 3. Iniciar MySQL normalmente
      echo 'Iniciando MySQL...'
      exec docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password
      "

  adminer:
    container_name: adminer-nuevo
    image: adminer
    restart: always
    depends_on:
      - db
    ports:
      - "8889:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db-nuevo
      ADMINER_DESIGN: pepa-linha